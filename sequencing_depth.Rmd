---
title: "R Notebook"
output: html_notebook
---


```{r}
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(vegan)
```

```{r}
# ---- USER PARAMETERS ----
depths <- c(1e5, 5e5, 1e6, 2e6, 3e6, 4e6, 5e6, 6e6, 7e6, 8e6, 9e6, 10e6)     # Target depths to simulate
n_reps <- 30                        # Replicates per depth
target_taxa <- c("Alphapapillomavirus 7", "Rotavirus C", "Teschovirus A", "Sapporo virus")  # pathogens to track
detection_thresholds <- c(1, 5, 10)  # read thresholds
```

```{r}
# Sanity check
#stopifnot(all(c("sample_name", "taxid", "tax_name", "read_count") %in% names(data)))

# Create wide count matrix: taxa x samples
count_mat <- species_data %>%
  group_by(sample_name, name) %>%
  summarise(reads = sum(nt_count, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = sample_name, values_from = reads, values_fill = 0)

taxa <- count_mat$name
count_mat <- as.data.frame(count_mat)
rownames(count_mat) <- taxa
count_mat <- count_mat[ , -1]  # remove tax_name column
```


```{r}
# ---- DOWNSAMPLING SIMULATION ----
simulate_downsampling <- function(count_mat, depths, n_reps, targets, detection_thresholds) {
  taxa <- rownames(count_mat)
  samples <- colnames(count_mat)
  
  results <- list()
  for (depth in depths) {
    for (rep in seq_len(n_reps)) {
      # For each sample, simulate multinomial sampling
      sim_counts <- sapply(samples, function(s) {
        x <- count_mat[[s]]
        total_reads <- sum(x)
        if (total_reads == 0) return(rep(0, length(x)))
        p <- x / total_reads
        n_draw <- min(depth, total_reads)
        as.numeric(rmultinom(1, size = n_draw, prob = p))
      })
      rownames(sim_counts) <- taxa

    # Diversity metrics (ensure they are numeric vectors, not matrices)
    richness <- as.numeric(apply(sim_counts, 2, function(x) sum(x > 0)))
    shannon  <- as.numeric(apply(sim_counts, 2, function(x) vegan::diversity(x, index = "shannon")))
    
    sim_df <- tibble::tibble(
      sample = samples,
      depth = depth,
      rep = rep,
      richness = richness,
      shannon = shannon
    )

      # Pathogen detection
      if (length(targets) > 0) {
        for (th in detection_thresholds) {
          for (t in targets) {
            if (t %in% taxa) {
              reads <- sim_counts[t, ]
              sim_df[[paste0("detect_", t, "_ge_", th)]] <- as.numeric(reads >= th)
            } else {
              sim_df[[paste0("detect_", t, "_ge_", th)]] <- NA_real_
            }
          }
        }
      }

      results[[length(results) + 1]] <- sim_df
    }
  }
  bind_rows(results)
}

```

```{r}
# Start the simulation!
res <- simulate_downsampling(count_mat, depths, n_reps, target_taxa, detection_thresholds)
```

```{r}
# ---- SUMMARIZE RESULTS ----
# Diversity summary
div_summary <- res %>%
  group_by(depth) %>%
  summarise(
    richness_mean = mean(richness),
    richness_sd = sd(richness),
    shannon_mean = mean(shannon),
    shannon_sd = sd(shannon),
    .groups = "drop"
  )

# Detection summary
det_cols <- grep("^detect_", names(res), value = TRUE)
det_summary <- res %>%
  group_by(depth) %>%
  summarise(across(all_of(det_cols), ~ mean(.x, na.rm = TRUE))) %>%
  pivot_longer(-depth, names_to = "target_thresh", values_to = "detect_prob") %>%
  mutate(
    target = sub("^detect_", "", target_thresh),
    target = sub("_ge_.*", "", target),
    threshold = sub(".*_ge_", "", target_thresh)
  )
```

```{r}
# Plot Rarefaction Curve
p1 <- ggplot(div_summary, aes(x = depth/1e6, y = richness_mean)) +
  geom_line(aes(y = richness_mean), color = "steelblue") +
  geom_point(aes(y = richness_mean), color = "steelblue") +
  geom_ribbon(aes(ymin = richness_mean - richness_sd, ymax = richness_mean + richness_sd),
              fill = "steelblue", alpha = 0.2) +
  labs(x = "Sequencing depth (million reads)", y = "Species richness",
       title = "Overall diversity vs sequencing depth") +
  theme_bw()
p1
```

```{r}
# Plot Target Curve
p2 <- ggplot(det_summary, aes(x = depth/1e6, y = detect_prob, color = target)) +
  geom_line() + geom_point() +
  facet_wrap(~threshold, labeller = labeller(threshold = function(x) paste("≥", x, "reads"))) +
  labs(x = "Depth (million reads)", y = "Detection probability",
       title = "Target pathogen detection vs sequencing depth") +
  theme_bw()

p2
```
```{r}
# Find the depth (per target + threshold) with the highest detection probability
best_depths <- det_summary %>%
  group_by(target, threshold) %>%
  filter(detect_prob >= 0.95 * max(detect_prob, na.rm = TRUE)) %>%
  slice_min(order_by = depth, n = 1)

# Add annotation labels
p3 <- ggplot(det_summary, aes(x = depth/1e6, y = detect_prob, color = target)) +
  geom_line() + geom_point() +
  facet_wrap(~threshold, labeller = labeller(threshold = function(x) paste("≥", x, "reads"))) +
  geom_vline(data = best_depths, aes(xintercept = depth/1e6, color = target),
             linetype = "dashed", alpha = 0.5) +
  geom_text(
    data = best_depths,
    aes(x = depth/1e6, y = detect_prob, label = paste0(depth/1e6, "M")),
    vjust = -0.8, size = 3, show.legend = FALSE
  ) +
  labs(x = "Depth (million reads)", y = "Detection probability",
       title = "Target pathogen detection vs sequencing depth") +
  theme_bw()

p3
```

